@{
    Layout = "~/Views/Shared/_ColumnsOne.cshtml";


    var pageHeadBuilder = EngineContext.Current.Resolve<IPageHeadBuilder>();
    pageHeadBuilder.AddTitleParts(T("PageTitle.Checkout").Text);
    Html.AddCssFileParts("~/Plugins/Payments.WeiXin/Content/css/paymentweixin.css");
}
@model Nop.Plugin.Payments.WeiXin.Models.WeiXinPaymentModel
@using Nop.Core.Infrastructure
@using Nop.Web.Framework;
@using Nop.Web.Framework.UI


<div class="page checkout-page order-completed-page">
    <div class="page-title">
        <h1>@T("Plugins.Payments.WeiXin.YouAreUsingWechatPay")</h1>
    </div>

    <div class="wechatpay-head">
        <div class="l-col-6">
            <div class="wechatpay-orderid">订单编号: @Model.OrderId</div>
            <div class="wechatpay-orderid">订单类型: 网上支付</div>
        </div>
        <div class="l-col-6">
            <div class="wechatpay-ordertotal-container">
                应付金额: <span class="wechatpay-ordertotal">@Model.Total</span>
            </div>
        </div>
    </div>
    <div class="page-body checkout-data">
        <div class="wepay-logo"></div>
        <div class="section order-completed">
            <div class="title">
                <strong>@T("Plugins.Payments.WeiXin.QrcodeOnlyValidTwoHours")</strong>
            </div>
            <div class="details">
                <div class="order-number">
                    <strong></strong>
                </div>
                <div class="details-link">
                    @if (!string.IsNullOrWhiteSpace(Model.QRCode))
                    {
                        <div class="custom-value qrcode">
                            <img src="@Model.QRCode"/>
                            <div class="qrcode-hint">@T("Plugins.Payments.WeiXin.PleaseUseWechatScan")<br/>@T("Plugins.Payments.WeiXin.ScanQrcodeToPay")</div>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function() {
        setInterval("checkPaymentStatus()", 10000);    
    });

    function checkPaymentStatus() {
        console.log("sending");
        var orderId = @Model.OrderId;
        if (orderId !== 0) {
            $.ajax({
                url: "/Plugins/PaymentWeiXin/QueryOrder",//调用ashx获得订单状态
                type: "POST",
                data: {
                    orderId: orderId
                },
                success: function (data) {
                    console.dir(data);
                    if (data === 'True') { //订单状态为1表示支付成功
                        window.location.href = "/Checkout/Completed"; //页面跳转
                    }
                },
                error: function () {
                    
                }
            });
        }

    }
</script>
